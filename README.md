## Tools & technologies used
- `Python` — for being fast in development and concept construction with wide range of libraries available
- `FastAPI` — for being small and effective with good documentation
- `WebSocket` — best match for bi-directional communication
- `UUID` — for being simple and reliable. It's used to identify all the entities (i.e. users, groups, teams, messages)
- `Uvicorn` — for being a de-facto standard for Python servers. Also the logging from this library is used

## How it works
Client and Server communicate through WebSocket. Both send messages with three fields: 
- `type` is used to determine the operation type
- `request_id` is used by clients to match requests and responses
- `data` is a payload

Requests and notifications use an actual `type`.
Responses only have two values in the `type` field: `success` or `error`.

Usually server receives `request_id` only to send it back (request -> response).
`request_id` of notifications is generated by server and is random. Serves as a placeholder.

### Test frontend
There is a test page to send requests/receive responses and notifications on the `/`.

### API architecture
#### set_id
##### request
``` json
{
    "type": "set_id",
    "data": "1a4012f5-e59b-4cc2-a321-e576b4a2af8e",
    "requestId": "c25c885f-8742-4d75-95aa-338248c82a60"
}
```

##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "c25c885f-8742-4d75-95aa-338248c82a60"
}
```

#### Disconnect
##### notification
``` json
{
    "type": "disconnect",
    "data": "b4df09ef-2d16-4046-b4db-c14e076356f7",
    "requestId": "8df02873-90e5-4235-bbf8-14cb709810fb"
}
```

#### Connect
##### notification
``` json
{
    "type": "connect",
    "data": "1093ad44-c45d-4e12-96fe-08e1cb188e33",
    "requestId": "1a3ecb9e-8264-41a1-8ea0-e70637545907"
}
```


#### set_user_info
##### request
``` json
{
    "type": "set_user_info",
    "data": {
        "userName": "Alex",
        "picture": "test"
    },
    "requestId": "b324e284-b580-4dcf-9940-a66842a42291"
}
```
##### response
``` json
{
    "type": "success",
    "data": {
        "userId": "1093ad44-c45d-4e12-96fe-08e1cb188e33"
    },
    "requestId": "b324e284-b580-4dcf-9940-a66842a42291"
}
```
##### notification
``` json
{
    "type": "set_user_info",
    "data": {
        "userId": "1a4012f5-e59b-4cc2-a321-e576b4a2af8e",
        "userName": "Alex",
        "picture": "test",
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "isReady": true
    },
    "requestId": "ef27fd78-002b-43d0-a0c9-984f2fce9a14"
}
```

#### get_user_info
##### request
``` json
{
    "type": "get_user_info",
    "data": "85ed8240-79fa-4e26-9ab0-3a609e71964f",
    "requestId": "db390b5f-3d04-479d-ab2f-466a867cf591"
}
```
##### response
``` json
{
    "type": "success",
    "data": {
        "userId": "1093ad44-c45d-4e12-96fe-08e1cb188e33",
        "userName": "Alex",
        "picture": "test",
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "isReady": true
    },
    "requestId": "db390b5f-3d04-479d-ab2f-466a867cf591"
}
```

##### Notification
No notificaton

#### set_group_info
##### request
``` json
{
    "type": "set_group_info",
    "data": {
        "groupName": "testgroup",
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9"
    },
    "requestId": "a4bc72ce-c01c-4501-85df-453dc9e375a1"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "a4bc72ce-c01c-4501-85df-453dc9e375a1"
}
```
##### notification
``` json
{
    "type": "set_group_info",
    "data": {
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "groupName": "testgroup",
        "groupMembers": [
            "1a4012f5-e59b-4cc2-a321-e576b4a2af8e",
            "98f99d9e-b7ec-4702-8fd9-f414c4c9d1cd"
        ],
        "isReady": true
    },
    "requestId": "c25c885f-8742-4d75-95aa-338248c82a60"
}
```

#### get_group_info
##### request
``` json
{
    "type": "get_group_info",
    "data": "eb8f9991-d198-4b10-9447-6486d0c945a9",
    "requestId": "f82f8661-352a-4d6c-a7a6-8df37d6003b2"
}
```
##### response
``` json
{
    "type": "success",
    "data": {
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "groupName": "testgroup",
        "groupMembers": [
            {
                "userId": "1a4012f5-e59b-4cc2-a321-e576b4a2af8e",
                "userName": "BestNickname",
                "picture": null,
                "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
                "isReady": true
            },
            {
                "userId": "98f99d9e-b7ec-4702-8fd9-f414c4c9d1cd",
                "userName": "Alex",
                "picture": "test",
                "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
                "isReady": true
            }
        ],
        "isReady": false
    },
    "requestId": "f82f8661-352a-4d6c-a7a6-8df37d6003b2"
}
```
##### Notification
No notificaton

#### join_group
##### request
``` json
{
    "type": "join_group",
    "data": "eb8f9991-d198-4b10-9447-6486d0c945a9",
    "requestId": "50b516cc-ea18-4453-b0a6-7c6f617dd1e5"
}
```
##### response
``` json
{
    "type": "success",
    "data": {
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "groupName": "testgroup",
        "groupMembers": [
            {
                "userId": "1a4012f5-e59b-4cc2-a321-e576b4a2af8e",
                "userName": "BestNickname",
                "picture": null,
                "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
                "isReady": true
            },
            {
                "userId": "98f99d9e-b7ec-4702-8fd9-f414c4c9d1cd",
                "userName": "Alex",
                "picture": "test",
                "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
                "isReady": true
            }
        ],
        "isReady": false
    },
    "requestId": "50b516cc-ea18-4453-b0a6-7c6f617dd1e5"
}
```
##### notification
``` json
{
    "type": "join_group",
    "data": {
        "userId": "e2b332c4-164d-47f7-8611-4af024d13192",
        "userName": "Alex",
        "picture": "test",
        "groupId": "eb8f9991-d198-4b10-9447-6486d0c945a9",
        "isReady": true
    },
    "requestId": "874934eb-c78d-4981-80fe-1e822a258114"
}
```

#### leave_group
##### request
``` json
{
    "type": "leave_group",
    "data": "eb8f9991-d198-4b10-9447-6486d0c945a9",
    "requestId": "28991484-e631-41bf-b853-ae3cb5f47da5"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "28991484-e631-41bf-b853-ae3cb5f47da5"
}
```
##### notification
``` json
{
    "type": "leave_group",
    "data": "eb8f9991-d198-4b10-9447-6486d0c945a9",
    "requestId": "28991484-e631-41bf-b853-ae3cb5f47da5"
}
```

#### leave_group
##### request
``` json
{
    "type": "leave_group",
    "data": null,
    "requestId": "28991484-e631-41bf-b853-ae3cb5f47da5"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "28991484-e631-41bf-b853-ae3cb5f47da5"
}
```
##### notification
``` json
{
    "type": "leave_group",
    "data": "e2b332c4-164d-47f7-8611-4af024d13192",
    "requestId": "78545cd8-250b-43bd-a179-0a7b649875dd"
}
```

#### delete_group
##### request
``` json
{
    "type": "delete_group",
    "data": null,
    "requestId": "23ce5565-719a-417c-8a3e-059c405430e0"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "23ce5565-719a-417c-8a3e-059c405430e0"
}
```
##### notification
``` json
{
    "type": "delete_group",
    "data": null,
    "requestId": "310d96c1-5d01-4f02-8573-dc860596b6a3"
}
```

#### set_teams
##### request
``` json
{
    "type": "set_teams",
    "data": [
        {
            "teamId": "1",
            "teamMembers": [
                "a2fedb51-4664-48f9-bfe0-be6ad48ddee5",
                "e2b332c4-164d-47f7-8611-4af024d13192"
            ]
        },
        {
            "teamId": "2",
            "teamMembers": [
                "1093ad44-c45d-4e12-96fe-08e1cb188e33",
                "41870a7e-3adf-4c08-92f8-e5f95a3f8fa7"
            ]
        }
    ],
    "requestId": "7f9dcbac-fe90-41a7-ab10-d8b7444f5b11"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "7f9dcbac-fe90-41a7-ab10-d8b7444f5b11"
}
```
##### notification
``` json
{
    "type": "set_teams",
    "data": [
        {
            "teamId": 1,
            "teamMembers": [
                "a2fedb51-4664-48f9-bfe0-be6ad48ddee5",
                "e2b332c4-164d-47f7-8611-4af024d13192"
            ]
        },
        {
            "teamId": 2,
            "teamMembers": [
                "1093ad44-c45d-4e12-96fe-08e1cb188e33",
                "41870a7e-3adf-4c08-92f8-e5f95a3f8fa7"
            ]
        }
    ],
    "requestId": "c8fd9a3c-10b5-4339-b026-5b853be2ed53"
}
```

#### get_teams
##### request
``` json
{
    "type": "get_teams",
    "data": null,
    "requestId": "8c75e987-4282-46b4-b8e6-b00bd22c2e44"
}
```
##### response
``` json
{
    "type": "success",
    "data": [
        {
            "teamId": 1,
            "teamMembers": [
                "a2fedb51-4664-48f9-bfe0-be6ad48ddee5",
                "e2b332c4-164d-47f7-8611-4af024d13192"
            ]
        },
        {
            "teamId": 2,
            "teamMembers": [
                "1093ad44-c45d-4e12-96fe-08e1cb188e33",
                "41870a7e-3adf-4c08-92f8-e5f95a3f8fa7"
            ]
        }
    ],
    "requestId": "8c75e987-4282-46b4-b8e6-b00bd22c2e44"
}
```
##### Notification
No notificaton

#### set_user_ready
##### request
``` json
{
    "type": "set_user_ready",
    "data": true,
    "requestId": "c8fd9a3c-10b5-4339-b026-5b853be2ed53"
}
```
##### response
``` json
{
    "type": "success",
    "data": {
        "userId": "e2b332c4-164d-47f7-8611-4af024d13192",
        "teamIsReady": true
    },
    "requestId": "c8fd9a3c-10b5-4339-b026-5b853be2ed53"
}
```
##### notification
``` json
{
    "type": "set_user_ready",
    "data": {
        "userId": "e2b332c4-164d-47f7-8611-4af024d13192",
        "isReady": true,
        "teamIsReady": true
    },
    "requestId": "a1adb497-5828-455e-8d86-49db58827f27"
}
```

#### set_group_ready
##### request
``` json
{
    "type": "set_group_ready",
    "data": true,
    "requestId": "bdf968bd-a2d8-4af0-bad4-62b5d7289535"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "bdf968bd-a2d8-4af0-bad4-62b5d7289535"
}
```
##### notification
``` json
{
    "type": "set_group_ready",
    "data": true,
    "requestId": "1cc5d10f-f52c-4969-90d4-ee0241b36db6"
}
```

#### collecting_stamps_start
##### request
``` json
{
    "type": "collecting_stamps_start",
    "data": null,
    "requestId": "471f939d-a88c-4918-9df7-38950eb8368f"
}
```
##### response
``` json
{
    "type": "success",
    "data": [
        {
            "questionText": "question 1 text",
            "correctAnswer": "answer 3 text"
            "wrongAnswers": [
                "answer 1 text",
                "answer 2 text"
            ],
        },
        {
            "questionText": "question 2 text",
            "correctAnswer": "answer 3 text"
            "wrongAnswers": [
                "answer 1 text",
                "answer 2 text"
            ],
        }
    ],
    "requestId": "471f939d-a88c-4918-9df7-38950eb8368f"
}
```
##### notification
``` json
{
    "type": "collecting_stamps_start",
    "data": [
        {
            "questionText": "question 1 text",
            "correctAnswer": "answer 3 text"
            "wrongAnswers": [
                "answer 1 text",
                "answer 2 text"
            ],
        },
        {
            "questionText": "question 2 text",
            "correctAnswer": "answer 3 text"
            "wrongAnswers": [
                "answer 1 text",
                "answer 2 text"
            ],
        }
    ],
    "requestId": "302c5029-2ece-40d3-a46e-ced4bed0b8e9"
}
```

#### collecting_stamps_progress
##### request
``` json
{
    "type": "collecting_stamps_progress",
    "data": {
        "questionText1": true,
        "questionText2": true,
        "questionText3": true,
    },
    "requestId": "<UUID>"
}
```
##### response
``` json
{
    "type": "success",
    "data": null,
    "requestId": "<UUID>"
}
```

## Problems faced
### Client disconnections due to unstable network connection
In such case the client should send the old ID in the `set_id` request right after reconnection. Client data is preserved on deisconnection.

### API architecture
Current API architecture is not very clean. This is a deliberate decision which should simplify and speed up the processing on the frontend.

Examples:
- `join_group` returns the whole group in the `data` field if executed successfully, while there is `get_group_info` for that purpose
- `get_group_info` returns user objects and not just IDs, while there is `get_user_info` for that purpose

### Lack of type safety
The longer the code is the more annoying this characteristic of Python becomes. Type hints help analysis tools to check types, but it's still bad. This slows down the development and increases the bug number.

### Preserve the participants order in the waiting room
This is important for the frontend (for the waiting room to look the same regardless of the joining time). For this purpose currently the `Ordered_set` was used.

## Further development
### Secure connection
This is a prototype, that's why `ws` is fine. But later on it should be replaced with its secure verison: `wss`.

### Proper database
Currently all the data is stored in simple Python lists/sets. It would make sense to use an in-memory database (SQL / Document DB like MongoDB).

### More tests
Currently there are only a few tests which serve as proof-of-concept. Tests should cover all the requests and check if all the notifications are sent correctly.

### Another language
Possible transition to compilable language. This can increase robustness and efficiency.

### Serve images directly
This may simplify the processing of the frontend 


## Server startup

### 1. Prerequisites
- Python 3

### 2. Preparation
#### 2.1 Create python virtual environment
    python -m venv venv
#### 2.2 Activate vitrual environment
##### Linux / WSL
    source ./venv/bin/activate
##### Windows
    venv\Scripts\Activate
#### 2.3 Update pip
    pip install --upgrade pip
#### 2.4 Install all the project dependencies
    pip install -r requirements.txt

### 3. Startup
#### • For a local development
    fastapi dev main.py
#### • For a connection from a physical device and/or for detailed logs
    uvicorn main:app --port 8000 --host :: --reload --log-level debug


## Setup server access from outside (Windows)

1. Do steps 2.1 - 2.4 from "Server startup" part.
2. Start the server with the following command:
    ```
    uvicorn main:app --host :: --port 8000 --reload
    ```
3. Open `cmd.exe`, execute the following command, and memorize the last number from the output. It is the process ID (PID).
    ```
    netstat -ao | find /i "listening" | find /i "8000"
    ```
4. Open `Task Manager` and switch to the `Details` tab. look for the PID from the previous step.
5. Once you found it, right click it and choose `Open file location`. Copy the path.
6. Navigate to Settings > Network & Internet > Status > Windows Firewall.
7. Choose `Allow an app through firewall`, then `Change settings` (with an admin sign). Click `Allow another app...` and `Browse...`.
8. Paste the previously copied path to the top bar and select the approppriate .exe file (that was listed in the task manager). Click `Add`.
9. Tick the checkbox in the `Private` column (and in the `Public` column also, if you wish). Click `OK` at the bottom.
10. Done!

## Production server

1. Clone the repo
2. Change to the repo directory
   ```
   cd train-hunt-backend/
   ```
3. Setup virtualenv
   ```
   python -m venv venv
   pip install -r requirements.txt
   ```
4. Run a transient systemd-service
   ```
   systemd-run \
      --user \
      --unit=TrainHuntServer \
      --property=Type=exec \
      --property=WorkingDirectory="$(pwd)" \
      --property=Environment="PATH=$(pwd)/venv/bin:$PATH" \
      --property=Environment="PYTHONPATH=$(pwd)" \
      --property=Restart=on-failure \
      --property=RestartSec=5 \
      --property=StartLimitIntervalSec=50 \
      --property=StartLimitBurst=3 \
      ./venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --log-level info
   ```
5. Done! You can view the logs in real-time with this command:
   ```
   journalctl --user -feu TrainHuntServer.service
   ```